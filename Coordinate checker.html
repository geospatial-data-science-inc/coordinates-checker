<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Health Facility GPS Validation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- DataTables CSS + Extensions -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/searchpanes/2.2.0/css/searchPanes.dataTables.min.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/select/1.7.0/css/select.dataTables.min.css" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0/js/select2.min.js"></script>

  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      padding: 20px;
      background: "#fffff";
    }

    .dashboard-container {
      margin: 0 auto;
      padding: 20px;
    }

    .validation-section {
      margin-bottom: 30px;
      padding: 15px;
      border: 1px solid #e9ecef;
      border-radius: 5px;
    }

    .outer-container {
      display: grid;
      grid-template-columns: auto 1fr 1fr;
      /* first column auto, next two equal fractions */
      gap: 20px;

    }

    .outer-container>div {
      min-width: 0;
    }

    .map-container {
      height: 550px;
      border-radius: 5px;
      overflow: hidden;
      margin-top: 10px;
    }

    .table-container {
      overflow: hidden;
    }

    .progress {
      height: 10px;
      margin-top: 5px;
    }

    #resultsTable thead select {

      font-size: 12px;
      padding: 2px 4px;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      background-color: #fff;
    }

    #resultsTable thead tr:nth-child(2) th {
      padding: 2px !important;
    }
  </style>
</head>

<body>

  <div class="dashboard-container">
    <div class="text-center mb-4">
      <h1>Health Facility GPS Validation</h1>
    </div>

    <div class="outer-container">
      <div class="col1">
        <div class="validation-section">
          <h5>1. Upload Data</h5>
          <label class="form-label">Select Country</label>
          <select class="form-select" id="countrySelect">
            <option value="">-- Select a country --</option>
            <option value="MWI">Malawi</option>
            <option value="KEN">Kenya</option>
            <option value="TZA">Tanzania</option>
            <option value="UGA">Uganda</option>
            <option value="ZMB">Zambia</option>
            <option value="ZWE">Zimbabwe</option>
          </select>

          <label class="form-label mt-3">Upload CSV File</label>
          <input type="file" class="form-control" id="fileUpload" accept=".csv">
          <div class="form-text">CSV columns: Name, x, y, Admin1, Admin2, Admin3</div>

          <button class="btn btn-primary mt-3" id="validateBtn" disabled>Validate Coordinates</button>
          <div class="api-status mt-2" id="apiStatus"></div>
        </div>

        <div class="validation-section">
          <h5>2. Data Summary</h5>
          <div id="dataSummary">
            <p class="text-muted">No data uploaded yet</p>
          </div>
        </div>
        <div class="validation-section">
          <h5>3. Validation Summary</h5>
          <div id="validationResults">
            <p class="text-muted">Upload a file and click validate</p>
          </div>
        </div>

      </div>
      <!-- Scripts -->

      <div class="col2">
        <div class="validation-section">
          <h5>4. Detailed Results</h5>
          <div class="table-container">

            <table class="table table-striped table-hover" id="resultsTable" style="width:100%">
              <thead>
                <tr>
                  <th>Facility</th>
                  <th>Longitude (X)</th>
                  <th>Latitude (Y)</th>
                  <th>Admin1</th>
                  <th>Admin2</th>
                  <th>Admin3</th>
                  <th>Country</th>
                  <th>Admin Area</th>
                  <th>Duplicates</th>
                  <th>Road</th>
                  <th>Water</th>
                  <th>Building</th>
                  <th>Population</th>
                  <th>Overture</th>
                  <th>Score</th>
                </tr>
              </thead>

              <tbody id="resultsBody"></tbody>
            </table>
          </div>
        </div>

      </div>
      <div class="col3">
        <div class="validation-section">
          <h5>5. Map View</h5>
          <div id="map" class="map-container"></div>
        </div>


      </div>
    </div>


  </div>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <!-- DataTables JS + Extensions -->
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/searchpanes/2.2.0/js/dataTables.searchPanes.min.js"></script>
  <script src="https://cdn.datatables.net/select/1.7.0/js/dataTables.select.min.js"></script>
  <script src="https://cdn.datatables.net/jszip/3.10.1/jszip.min.js"></script>

  <script>

    // ✅ Initialize DataTable after page load
    $(document).ready(function () {
      // initialize DataTable with Excel-like features
      window.resultsTable = $('#resultsTable').DataTable({
        searchPanes: {
          cascadePanes: true,
          viewTotal: true
        },
        buttons: [
          {
            extend: 'excelHtml5',
            text: 'Export to Excel',
            className: 'btn btn-success btn-sm'
          },
          {
            extend: 'csvHtml5',
            text: 'Export CSV',
            className: 'btn btn-outline-primary btn-sm'
          }
        ],
        pageLength: 10,
        responsive: true,
        order: [],
        scrollY: "400px",     // table body height
        scrollCollapse: true, // collapse if fewer rows
        scrollX: true,        // horizontal scroll for wide tables
        language: {
          search: "Search"
        }
      });
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <script>

    // --- Base layers ---
    const streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    });

    const satelliteLayer = L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
      {
        attribution: 'Tiles © Esri — Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
        maxZoom: 20
      }
    );

    // Initialize map
    const map = L.map('map', {
      center: [-13.2543, 34.3015],
      zoom: 6,
      layers: [streetLayer] // default layer
    });

    // Layer switcher
    const baseMaps = {
      "OSM": streetLayer,
      "Satellite": satelliteLayer
    };
    L.control.layers(baseMaps).addTo(map);



    let uploadedData = [];
    let countryBoundaryLayer = null;
    let markers = {};
    const countryAlpha2Map = { MWI: 'mw', KEN: 'ke', TZA: 'tz', UGA: 'ug', ZMB: 'zm', ZWE: 'zw' };

    const API_CONFIG = {
      worldpop: 'http://localhost:5000/api/worldpop',
      nominatim: 'http://localhost:5000/api/nominatim',
      overture: 'http://localhost:5000/api/overture',
      road_distance: 'http://localhost:5000/api/road_distance',
      building_distance: 'http://localhost:5000/api/building_distance',
      water_check: 'http://localhost:5000/api/water_check'
    };

    // File upload handling
    document.getElementById('fileUpload').addEventListener('change', handleFileUpload);
    document.getElementById('countrySelect').addEventListener('change', () => {
      const country = document.getElementById('countrySelect').value;
      if (country) loadCountryBoundary(country);
      updateValidateButton();
    });
    document.getElementById('validateBtn').addEventListener('click', validateCoordinates);

    function handleFileUpload(e) {
      const file = e.target.files[0];
      if (!file) return;
      Papa.parse(file, {
        header: true,
        complete: function (results) {
          uploadedData = results.data.filter(r => r.Name && r.x && r.y);
          updateValidateButton();
          updateDataSummary();
        }
      });
    }

    function updateValidateButton() {
      const country = document.getElementById('countrySelect').value;
      document.getElementById('validateBtn').disabled = !(country && uploadedData.length > 0);
    }

    function updateDataSummary() {
      const summaryDiv = document.getElementById('dataSummary');
      if (uploadedData.length === 0) {
        summaryDiv.innerHTML = '<p class="text-muted">No data uploaded yet</p>';
        return;
      }
      summaryDiv.innerHTML = `
    <p><strong>Facilities:</strong> ${uploadedData.length}</p>
    <p><strong>X range:</strong> ${Math.min(...uploadedData.map(d => parseFloat(d.x)))} - ${Math.max(...uploadedData.map(d => parseFloat(d.x)))}</p>
    <p><strong>Y range:</strong> ${Math.min(...uploadedData.map(d => parseFloat(d.y)))} - ${Math.max(...uploadedData.map(d => parseFloat(d.y)))}</p>
  `;
    }

    async function loadCountryBoundary(countryCode) {
      updateApiStatus('Loading country boundary...');
      try {
        const res = await fetch(`https://nominatim.openstreetmap.org/search?country=${countryCode}&polygon_geojson=1&format=json`);
        const data = await res.json();
        if (data && data[0].geojson) {
          if (countryBoundaryLayer) map.removeLayer(countryBoundaryLayer);
          countryBoundaryLayer = L.geoJSON(data[0].geojson, { style: { color: 'blue', weight: 2, fillOpacity: 0.1 } }).addTo(map);
          map.fitBounds(countryBoundaryLayer.getBounds());
          updateApiStatus('Country boundary loaded');
        }
      } catch (e) {
        console.error(e);
        updateApiStatus('Could not load country boundary');
      }
    }

    function normalize(str) {
      return str ? str.toLowerCase().replace(/\s+/g, '').trim() : '';
    }

    // --- Core validation ---
    async function validateCoordinates() {
      const country = document.getElementById('countrySelect').value;
      const results = [];

      for (let i = 0; i < uploadedData.length; i++) {
        const f = uploadedData[i];
        const x = parseFloat(f.x), y = parseFloat(f.y);

        updateApiStatus(`Validating facility ${i + 1}/${uploadedData.length}: ${f.Name}`);
        // --- Country boundary check ---
        try {
          const countryResp = await fetch(`${API_CONFIG.nominatim}?format=json&lat=${y}&lon=${x}`);
          const countryData = await countryResp.json();
          const expectedCountry = countryAlpha2Map[country];
          f.countryBoundary = {
            valid: countryData.address?.country_code === expectedCountry,
            message: countryData.address?.country || 'Unknown'
          };
        } catch (e) {
          f.countryBoundary = { valid: false, message: 'Country check failed', error: e.message };
        }

        // --- Admin area check ---
        try {
          const adminResp = await fetch(`${API_CONFIG.nominatim}?format=json&lat=${y}&lon=${x}&addressdetails=1`);
          const adminData = await adminResp.json();
          const osm1 = normalize(adminData.address?.state || adminData.address?.region);
          const osm2 = normalize(adminData.address?.county || adminData.address?.district);
          const admin1 = normalize(f.Admin1), admin2 = normalize(f.Admin2);
          let score = 0, msg = "Admin area mismatch";
          if (admin1 && osm1.includes(admin1)) { score += 50; msg = "Admin1 matches"; }
          if (admin2 && osm2.includes(admin2)) { score += 50; msg = score === 100 ? "Admin areas match" : "Admin2 matches"; }
          f.adminAreaMatch = { valid: score > 0, score, message: msg };
        } catch (e) {
          f.adminAreaMatch = { valid: false, score: 0, message: 'Admin check failed', error: e.message };
        }

        // --- Duplicate check ---
        const threshold = 0.001;
        const duplicates = uploadedData.filter(o => o !== f && Math.abs(parseFloat(o.x) - x) < threshold && Math.abs(parseFloat(o.y) - y) < threshold);
        f.duplicateCheck = { valid: duplicates.length === 0, message: duplicates.length === 0 ? 'No duplicates' : `${duplicates.length} duplicates` };

        // --- Road distance ---
        try {
          const roadResp = await fetch(`${API_CONFIG.road_distance}?lat=${y}&lon=${x}`);
          const roadData = await roadResp.json();
          f.roadDistance = roadData.valid ? { valid: true, distance: roadData.distance } : { valid: false, distance: null };
        } catch {
          f.roadDistance = { valid: false, message: 'Road distance failed' };
        }

        // --- Building distance ---
        try {
          const buildResp = await fetch(`${API_CONFIG.building_distance}?lat=${y}&lon=${x}`);
          const buildData = await buildResp.json();
          f.buildingDistance = buildData.valid ? { valid: true, distance: buildData.distance } : { valid: false, distance: null };
        } catch {
          f.buildingDistance = { valid: false, message: 'Building distance failed' };
        }

        // --- Water check ---
        try {
          const waterResp = await fetch(`${API_CONFIG.water_check}?lat=${y}&lon=${x}`);
          const waterData = await waterResp.json();
          f.waterCheck = waterData.valid !== undefined
            ? { valid: waterData.valid, message: waterData.message }
            : { valid: false, message: 'Water check failed' };
        } catch {
          f.waterCheck = { valid: false, message: 'Water check failed' };
        }

        // --- Population density ---
        try {
          const popResp = await fetch(`${API_CONFIG.worldpop}?latitude=${y}&longitude=${x}&buffer=1`);
          const popData = await popResp.json();
          const density = popData.population_density || 0;
          f.populationDensity = { valid: density > 100, density, message: `Pop density ${Math.round(density)}` };
        } catch {
          f.populationDensity = { valid: false, density: 0, message: 'Population check failed' };
        }

        // --- Overture match ---
        try {
          const overtureResp = await fetch(`${API_CONFIG.overture}?lat=${y}&lon=${x}`);
          const overtureData = await overtureResp.json();
          f.overtureMatch = overtureData.valid
            ? { valid: true, message: overtureData.message, score: 100 }
            : { valid: false, message: overtureData.message, score: 0 };
        } catch {
          f.overtureMatch = { valid: false, message: 'Overture check failed', score: 0 };
        }

        // --- Overall score ---
        f.overallScore = Math.round(
          (f.countryBoundary.valid ? 1 : 0) * 20 +
          f.adminAreaMatch.score * 0.15 +
          (f.duplicateCheck.valid ? 1 : 0) * 15 +
          (f.roadDistance.valid ? 1 : 0) * 10 +
          (f.buildingDistance.valid ? 1 : 0) * 10 +
          (f.waterCheck.valid ? 1 : 0) * 10 +
          (f.populationDensity.valid ? 1 : 0) * 10 +
          (f.overtureMatch.valid ? 1 : 0) * 25
        );

        results.push(f);

      }

      // Final status
      updateApiStatus(`Validation complete: ${results.length} facilities processed`);
      displayValidationResults(results);
      updateMap(results);
      updateResultsTable(results);
    }

    // --- Display and map ---
    function displayValidationResults(results) {
      const div = document.getElementById('validationResults');
      const valid = results.filter(r => r.overallScore >= 70).length;
      const warn = results.filter(r => r.overallScore >= 50 && r.overallScore < 70).length;
      const invalid = results.filter(r => r.overallScore < 50).length;
      div.innerHTML = `
    <div class="d-flex justify-content-between mb-2">
      <span class="badge bg-success">Valid: ${valid}</span>
      <span class="badge bg-warning">Warning: ${warn}</span>
      <span class="badge bg-danger">Invalid: ${invalid}</span>
    </div>
  `;
    }

    function updateMap(results) {
      // Clear existing markers
      map.eachLayer(l => { if (l instanceof L.Marker) map.removeLayer(l); });
      markers = {}; // reset

      results.forEach((f, i) => {
        const color = f.overallScore >= 70 ? 'green' : f.overallScore >= 50 ? 'orange' : 'red';
        const m = L.marker([parseFloat(f.y), parseFloat(f.x)], {
          icon: L.divIcon({
            className: 'custom-marker',
            html: `<div style="background-color:${color};width:12px;height:12px;border-radius:50%;border:2px solid white;"></div>`,
            iconSize: [16, 16],
            iconAnchor: [8, 8]
          })
        }).addTo(map);

        m.bindPopup(`
          <strong>${f.Name}</strong><br>
          ${f.x},${f.y}<br>
          Score: ${f.overallScore}%<br>
          Country: ${f.countryBoundary.message}<br>
          Water: ${f.waterCheck.message}
        `);

        // Save marker reference
        markers[i] = m;
      });
    }

    function updateResultsTable(results) {
      if ($.fn.DataTable.isDataTable('#resultsTable')) {
        // clear the existing table first
        window.resultsTable.clear().destroy();
      }

      const tbody = document.getElementById('resultsBody');
      tbody.innerHTML = '';

      results.forEach(f => {
        const row = document.createElement('tr');
        row.className = f.overallScore >= 70 ? 'table-success' :
          f.overallScore >= 50 ? 'table-warning' : 'table-danger';
        row.innerHTML = `
          <td>${f.Name}</td>
          <td>${f.x || ''}</td>
          <td>${f.y || ''}</td>
          <td>${f.Admin1 || ''}</td>
          <td>${f.Admin2 || ''}</td>
          <td>${f.Admin3 || ''}</td>
          <td><span class="badge ${f.countryBoundary.valid ? 'bg-success' : 'bg-danger'}">${f.countryBoundary.valid ? '✓' : '✗'}</span></td>
          <td><span class="badge ${f.adminAreaMatch.valid ? 'bg-success' : 'bg-warning'}">${f.adminAreaMatch.valid ? '✓' : '!'}</span></td>
          <td><span class="badge ${f.duplicateCheck.valid ? 'bg-success' : 'bg-danger'}">${f.duplicateCheck.valid ? '✓' : '✗'}</span></td>
          <td><span class="badge ${f.roadDistance.valid ? 'bg-success' : 'bg-warning'}">${f.roadDistance.distance ? f.roadDistance.distance.toFixed(0) + 'm' : 'N/A'}</span></td>
          <td><span class="badge ${f.waterCheck.valid ? 'bg-success' : 'bg-warning'}">${f.waterCheck.message || 'N/A'}</span></td>
          <td><span class="badge ${f.buildingDistance.valid ? 'bg-success' : 'bg-warning'}">${f.buildingDistance.distance ? f.buildingDistance.distance.toFixed(0) + 'm' : 'N/A'}</span></td>
          <td><span class="badge ${f.populationDensity.valid ? 'bg-success' : 'bg-warning'}">${f.populationDensity.density ? f.populationDensity.density.toFixed(0) : 'N/A'}</span></td>
          <td><span class="badge ${f.overtureMatch.valid ? 'bg-success' : 'bg-secondary'}">✓</span></td>
          <td><span class="badge ${f.overallScore >= 70 ? 'bg-success' : f.overallScore >= 50 ? 'bg-warning' : 'bg-danger'}">${f.overallScore}%</span></td>
        `;
        tbody.appendChild(row);
      });

      // ✅ Reinitialize DataTable after rows are added
      window.resultsTable = $('#resultsTable').DataTable({


        pageLength: 10,
        responsive: true,
        order: [],
        scrollY: "400px",     // table body height
        scrollCollapse: true, // collapse if fewer rows
        scrollX: true,        // horizontal scroll for wide tables


      });

      // ✅ Add row click handler to zoom to marker
      $('#resultsTable tbody').off('click').on('click', 'tr', function () {
        const rowIndex = window.resultsTable.row(this).index(); // get DataTable row index
        const marker = markers[rowIndex];
        if (marker) {
          map.setView(marker.getLatLng(), 16); // zoom in to the marker
          marker.openPopup(); // optional: open popup
        }
      });

    }


    function updateApiStatus(msg) {
      document.getElementById('apiStatus').textContent = msg;
    }
  </script>

</body>

</html>